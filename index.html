<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just Move Vancouver - Referral Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --navy: #001f3f;
            --accent-color: #ea580c;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --background-light: #f9fafb;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .logo {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .share-button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 30px;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .stat-card.accent {
            background: linear-gradient(135deg, var(--accent-color) 0%, #dc2626 100%);
            color: white;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .goal-section {
            background: var(--background-light);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid var(--border-color);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goal-header h2 {
            font-size: 1.5em;
            color: var(--navy);
        }

        .edit-goal-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .edit-goal-btn:hover {
            background: var(--secondary-color);
        }

        .progress-bar {
            width: 100%;
            height: 35px;
            background: #e0e0e0;
            border-radius: 17px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.95em;
        }

        .progress-text {
            text-align: center;
            font-size: 1.1em;
            color: var(--text-dark);
            font-weight: 500;
        }

        .charts-section {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .chart-container {
            background: var(--background-light);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }

        .chart-container h3 {
            color: var(--navy);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: var(--navy);
        }

        .qr-code {
            margin: 20px 0;
            padding: 20px;
            background: var(--background-light);
            border-radius: 10px;
        }

        .qr-code img {
            max-width: 200px;
            height: auto;
        }

        .referral-url {
            background: var(--background-light);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }

        .copy-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: var(--secondary-color);
        }

        .close-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
        }

        .goal-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .goal-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .celebration {
            font-size: 3em;
            margin: 20px 0;
        }

        .milestone-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .dashboard {
                padding: 20px;
                margin: 0;
            }

            .header {
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .logo {
                max-width: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-top: 30px;
            }

            .chart-container {
                padding: 20px;
                margin: 0 auto;
                width: 100%;
            }

            .chart-container canvas {
                margin: 0 auto;
                display: block;
            }

            .share-button {
                width: 100%;
                padding: 15px;
            }

            .goal-section {
                padding: 20px;
            }

            .goal-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .edit-goal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://i.imgur.com/NA0efXT.png" alt="Just Move Vancouver" class="logo">
            <h1>Your Referral Dashboard</h1>
            <p>Keep moving forward with every referral!</p>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Loading your dashboard...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" class="dashboard">
            <button class="share-button" onclick="showShareModal()">
                ðŸ“¤ Share Your Referral Link
            </button>

            <div class="goal-section">
                <div class="goal-header">
                    <h2>This Month's Goal</h2>
                    <button class="edit-goal-btn" onclick="showGoalModal()">Edit Goal</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                <div class="progress-text" id="progressText">
                    Loading...
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Last Month's Payout</div>
                    <div class="stat-value" id="lastMonthPayout">$0</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">Total Payouts</div>
                    <div class="stat-value" id="totalPayouts">$0</div>
                </div>
                <div class="stat-card accent">
                    <div class="stat-label">Total Pending</div>
                    <div class="stat-value" id="totalPending">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Referrals This Month</div>
                    <div class="stat-value" id="referralsThisMonth">0</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">Total Referrals</div>
                    <div class="stat-value" id="totalReferrals">0</div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <h3>ðŸ“ˆ Referrals Over Time</h3>
                    <canvas id="referralsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>ðŸ’° Earnings Breakdown</h3>
                    <canvas id="earningsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h2>Share Your Referral Link</h2>
            <div class="qr-code">
                <img id="qrCodeImage" src="" alt="QR Code">
            </div>
            <div class="referral-url" id="referralUrl"></div>
            <button class="copy-btn" onclick="copyReferralUrl()">ðŸ“‹ Copy Link</button>
            <button class="close-btn" onclick="closeShareModal()">Close</button>
        </div>
    </div>

    <!-- Goal Setting Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <h2>Set Your Monthly Goal</h2>
            <p>How many referrals do you want to achieve this month?</p>
            <input type="number" id="goalInput" class="goal-input" placeholder="Enter number of referrals" min="1">
            <div>
                <button class="copy-btn" onclick="saveGoal()">Save Goal</button>
                <button class="close-btn" onclick="closeGoalModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Goal Prompt Modal (for new month) -->
    <div id="goalPromptModal" class="modal">
        <div class="modal-content">
            <div class="celebration">ðŸŽ¯</div>
            <h2>Set Your Goal for This Month!</h2>
            <p>Let's make this month even better. How many referrals are you aiming for?</p>
            <input type="number" id="goalPromptInput" class="goal-input" placeholder="Enter your goal" min="1">
            <div>
                <button class="copy-btn" onclick="savePromptGoal()">Let's Go!</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - REPLACE WITH YOUR N8N WEBHOOK URL WHEN READY
        const N8N_WEBHOOK_URL = 'YOUR_N8N_WEBHOOK_URL_HERE';
        const DEMO_MODE = true; // Set to false when connecting to n8n
        
        let userData = null;
        let referralsChart = null;
        let earningsChart = null;

        // Demo data for design preview
        const DEMO_DATA = {
            lastMonthPayout: 325.00,
            totalPayouts: 2150.00,
            totalPending: 125.50,
            referralsThisMonth: 7,
            totalReferrals: 28,
            monthlyGoal: 10,
            goalSetMonth: "2025-10",
            referralUrl: "https://justmovevancouver.com/ref/DEMO123",
            qrCode: "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://justmovevancouver.com/ref/DEMO123",
            referralsByMonth: [
                { month: 'May', count: 3 },
                { month: 'Jun', count: 5 },
                { month: 'Jul', count: 6 },
                { month: 'Aug', count: 4 },
                { month: 'Sep', count: 3 },
                { month: 'Oct', count: 7 }
            ]
        };

        // Format currency
        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2);
        }

        // Get current month in YYYY-MM format
        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        // Get token from URL
        function getToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load user data from n8n or use demo data
        async function loadData() {
            if (DEMO_MODE) {
                userData = DEMO_DATA;
                renderDashboard();
                return;
            }

            const token = getToken();
            
            if (!token) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Invalid access link. Please use the link provided in your email.';
                return;
            }

            try {
                const response = await fetch(`${N8N_WEBHOOK_URL}?token=${token}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }

                userData = await response.json();
                renderDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Unable to load your dashboard. Please try again later.';
            }
        }

        // Render dashboard with data
        function renderDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Update stats
            document.getElementById('lastMonthPayout').textContent = formatCurrency(userData.lastMonthPayout);
            document.getElementById('totalPayouts').textContent = formatCurrency(userData.totalPayouts);
            document.getElementById('totalPending').textContent = formatCurrency(userData.totalPending);
            document.getElementById('referralsThisMonth').textContent = userData.referralsThisMonth || 0;
            document.getElementById('totalReferrals').textContent = userData.totalReferrals || 0;

            // Update goal progress
            updateGoalProgress();

            // Create charts
            createReferralsChart();
            createEarningsChart();

            // Check if goal needs to be set for current month (skip in demo mode)
            if (!DEMO_MODE) {
                const currentMonth = getCurrentMonth();
                if (!userData.goalSetMonth || userData.goalSetMonth !== currentMonth) {
                    setTimeout(() => {
                        document.getElementById('goalPromptModal').classList.add('active');
                    }, 1000);
                }
            }
        }

        // Update goal progress display
        function updateGoalProgress() {
            const goal = userData.monthlyGoal || 0;
            const current = userData.referralsThisMonth || 0;
            
            if (goal === 0) {
                document.getElementById('progressText').textContent = 'Set a goal to start tracking your progress!';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercent').textContent = '';
                return;
            }

            const percentage = Math.min((current / goal) * 100, 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = Math.round(percentage) + '%';
            
            if (current >= goal) {
                document.getElementById('progressText').innerHTML = 'ðŸŽ‰ Goal achieved! You\'re crushing it! <span class="milestone-badge">GOAL MET!</span>';
            } else {
                const remaining = goal - current;
                document.getElementById('progressText').textContent = `${current} of ${goal} referrals | ${remaining} to go!`;
            }
        }

        // Create referrals over time chart
        function createReferralsChart() {
            const ctx = document.getElementById('referralsChart').getContext('2d');
            
            const data = userData.referralsByMonth || DEMO_DATA.referralsByMonth;
            
            referralsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Referrals',
                        data: data.map(d => d.count),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Create earnings breakdown chart
        function createEarningsChart() {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            
            earningsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid Out', 'Pending'],
                    datasets: [{
                        data: [userData.totalPayouts, userData.totalPending],
                        backgroundColor: [
                            '#2563eb',
                            '#ea580c'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Show share modal
        function showShareModal() {
            document.getElementById('referralUrl').textContent = userData.referralUrl;
            document.getElementById('qrCodeImage').src = userData.qrCode;
            document.getElementById('shareModal').classList.add('active');
        }

        // Close share modal
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        // Copy referral URL
        function copyReferralUrl() {
            const url = userData.referralUrl;
            navigator.clipboard.writeText(url).then(() => {
                alert('Referral link copied to clipboard!');
            });
        }

        // Show goal modal
        function showGoalModal() {
            document.getElementById('goalInput').value = userData.monthlyGoal || '';
            document.getElementById('goalModal').classList.add('active');
        }

        // Close goal modal
        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
        }

        // Save goal from edit modal
        async function saveGoal() {
            const goal = parseInt(document.getElementById('goalInput').value);
            
            if (!goal || goal < 1) {
                alert('Please enter a valid goal');
                return;
            }

            await updateGoal(goal);
            closeGoalModal();
        }

        // Save goal from prompt modal
        async function savePromptGoal() {
            const goal = parseInt(document.getElementById('goalPromptInput').value);
            
            if (!goal || goal < 1) {
                alert('Please enter a valid goal');
                return;
            }

            await updateGoal(goal);
            document.getElementById('goalPromptModal').classList.remove('active');
        }

        // Update goal via n8n or locally in demo mode
        async function updateGoal(goal) {
            if (DEMO_MODE) {
                userData.monthlyGoal = goal;
                userData.goalSetMonth = getCurrentMonth();
                updateGoalProgress();
                return;
            }

            const token = getToken();
            
            try {
                await fetch(`${N8N_WEBHOOK_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        monthlyGoal: goal,
                        goalSetMonth: getCurrentMonth()
                    })
                });

                userData.monthlyGoal = goal;
                userData.goalSetMonth = getCurrentMonth();
                updateGoalProgress();
                
            } catch (error) {
                console.error('Error saving goal:', error);
                alert('Failed to save goal. Please try again.');
            }
        }

        // Initialize dashboard on load
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
